# 喂了么数据库维护说明

数据库文件：**`server/data/weileme.db`**（SQLite 单文件）

---

## 一、日常维护

### 1. 备份

**方式 A：用脚本备份（推荐）**

```bash
cd server
npm run backup-db
```

会在 `server/data/backups/` 下生成带时间戳的副本，例如 `weileme_20260210_123456.db`。

**方式 B：手动复制**

- 先停止或确保没有大量写入时，直接复制 `data/weileme.db` 到安全目录或另一台机器。

### 2. 恢复

- 用某次备份文件覆盖当前 `data/weileme.db`（先停掉正在跑的服务）。
- 或把备份文件重命名为 `weileme.db` 放到 `data/` 下，再启动服务。

### 3. 查看 / 改数据

- **图形工具**：用 [DB Browser for SQLite](https://sqlitebrowser.org/) 或 VS Code 插件 “SQLite Viewer” 打开 `data/weileme.db`，可查表、改数据、执行 SQL。
- **命令行**：在项目根目录执行  
  `cd server && npx better-sqlite3 data/weileme.db`  
  然后输入 SQL（如 `SELECT * FROM orders;`）。  
  或直接用系统 sqlite3：`sqlite3 server/data/weileme.db`（若已安装）。

**主要表：**

| 表名         | 说明           |
|--------------|----------------|
| workers      | 上门人         |
| orders       | 订单           |
| order_media  | 订单服务媒体   |

---

## 二、开发 / 调试

### 清空并重建表（慎用，会丢数据）

```bash
cd server
npm run reset-db
```

会删除并重新创建所有表，相当于全新空库。仅建议在本地开发、测试时使用。

### 只重建表结构（不删数据）

当前项目启动时会执行 `CREATE TABLE IF NOT EXISTS`，不会删已有表。若你手动改过表结构或怀疑表坏了，可以：

1. 备份：`npm run backup-db`
2. 用 DB Browser 或 sqlite3 执行你的 `ALTER TABLE` 等语句，或
3. 需要“从零建表”时：备份后删掉 `weileme.db`，再启动服务，会自动重新建表（此时库是空的）。

---

## 三、生产环境建议

1. **定期备份**：用 cron / 计划任务每天执行 `npm run backup-db`，并把 `data/backups/` 拷到其他机器或对象存储。
2. **备份保留策略**：例如只保留最近 7 天或 30 天的备份，避免占满磁盘。
3. **升级表结构**：新增列、新表时先备份，再在测试环境执行 `ALTER TABLE` 或新表脚本，确认无误后再在生产执行。

---

## 四、常用 SQL 示例

```sql
-- 订单数量按状态统计
SELECT status, COUNT(*) FROM orders GROUP BY status;

-- 最近 10 条订单
SELECT id, date, address, status, created_at FROM orders ORDER BY created_at DESC LIMIT 10;

-- 某上门人的任务
SELECT * FROM orders WHERE worker_id = 1 ORDER BY date;

-- 清理已完成订单的媒体（慎用）
-- DELETE FROM order_media WHERE order_id IN (SELECT id FROM orders WHERE status = 'completed');
```

如有新表或字段，把对应建表/改表语句记在本文档或 `scripts/` 下，方便以后维护和迁移。
